<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è¡¨</title>
    <style>
      :root {
        --primary: #1a73e8;
        --primary-light: #e8f0fe;
        --holiday: #c62828;
        --holiday-bg: #ffebee;
        --workday: #2e7d32;
        --workday-bg: #e8f5e9;
        --border: #e0e0e0;
        --text: #424242;
        --text-light: #757575;
        --weekend: #fafafa;
        --weekend-tag: #78909c;
        --weekend-tag-bg: #eceff1;
        --adjusted: #6a1b9a;
        --adjusted-bg: #f3e5f5;
        --special: #ef6c00;
        --special-bg: #fff3e0;
        --today: #1565c0;
        --today-bg: #e3f2fd;
      }
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: "Google Sans", "Segoe UI", Arial, sans-serif;
        background: #fff;
        color: var(--text);
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
      }
      .header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 16px;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border);
      }
      .header h1 {
        font-size: 22px;
        font-weight: 400;
        color: var(--text);
        flex: 1;
      }
      .header h1 span {
        font-size: 14px;
        color: var(--primary);
        background: var(--primary-light);
        padding: 4px 10px;
        border-radius: 12px;
        margin-left: 8px;
      }
      .controls {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .nav-btn {
        background: none;
        border: 1px solid var(--border);
        border-radius: 4px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        color: var(--text);
        transition: background 0.2s;
      }
      .nav-btn:hover {
        background: var(--weekend);
      }
      .nav-btn.primary {
        background: var(--primary);
        color: #fff;
        border-color: var(--primary);
      }
      .nav-btn.primary:hover {
        background: #1557b0;
      }
      select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        background: #fff;
      }
      .nav-links {
        display: flex;
        gap: 8px;
        margin-left: auto;
      }
      .nav-link {
        text-decoration: none;
        color: var(--primary);
        font-size: 14px;
        padding: 8px 12px;
        border-radius: 4px;
        transition: background 0.2s;
      }
      .nav-link:hover {
        background: var(--primary-light);
      }
      .calendar {
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }
      .calendar-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: var(--weekend);
        border-bottom: 1px solid var(--border);
      }
      .calendar-header div {
        padding: 12px;
        text-align: center;
        font-size: 12px;
        font-weight: 500;
        color: var(--text-light);
        text-transform: uppercase;
      }
      .calendar-header div:first-child,
      .calendar-header div:last-child {
        color: var(--holiday);
      }
      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        height: 540px; /* å›ºå®šå¤–æ¡†é«˜åº¦ */
      }
      .calendar-grid.weeks-5 {
        grid-template-rows: repeat(5, 1fr);
      }
      .calendar-grid.weeks-6 {
        grid-template-rows: repeat(6, 1fr);
      }
      .day-cell {
        border-right: 1px solid var(--border);
        border-bottom: 1px solid var(--border);
        padding: 4px;
        position: relative;
        cursor: default;
        overflow: hidden;
      }
      .day-cell:nth-child(7n) {
        border-right: none;
      }
      .day-cell.other-month {
        background: #f5f5f5;
      }
      .day-cell.other-month .day-number {
        color: #ccc;
      }
      .day-cell.weekend {
        background: var(--weekend);
      }
      .day-cell.today .day-number {
        background: var(--today);
        color: #fff;
      }
      .day-number {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        font-size: 14px;
        font-weight: 500;
        border-radius: 50%;
        margin-bottom: 2px;
      }
      .day-events {
        font-size: 11px;
        line-height: 1.4;
      }
      .event {
        padding: 2px 6px;
        border-radius: 3px;
        margin-bottom: 2px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .event.holiday {
        background: var(--holiday-bg);
        color: var(--holiday);
      }
      .event.workday {
        background: var(--workday-bg);
        color: var(--workday);
      }
      .event.weekend {
        background: transparent;
        color: #9e9e9e;
        font-weight: 400;
      }
      .event.adjusted {
        background: var(--adjusted-bg);
        color: var(--adjusted);
      }
      .event.special {
        background: var(--special-bg);
        color: var(--special);
      }
      .legend {
        display: flex;
        gap: 16px;
        margin-top: 16px;
        padding: 12px;
        background: var(--weekend);
        border-radius: 8px;
        flex-wrap: wrap;
      }
      .legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: var(--text-light);
      }
      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }
      .footer {
        margin-top: 16px;
        text-align: center;
        font-size: 12px;
        color: var(--text-light);
      }
      .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 400px;
        color: var(--text-light);
      }
      @media (max-width: 768px) {
        .day-cell {
          min-height: 60px;
        }
        .day-number {
          width: 24px;
          height: 24px;
          font-size: 12px;
        }
        .day-events {
          display: none;
        }
        .header h1 {
          font-size: 18px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“… è¡Œæ”¿æ©Ÿé—œè¾¦å…¬æ—¥æ›†è¡¨<span>æœˆæ›†ç‰ˆ</span></h1>
        <div class="controls">
          <button class="nav-btn" id="prevMonth">â—€ ä¸Šæœˆ</button>
          <select id="yearSelect"></select>
          <select id="monthSelect"></select>
          <button class="nav-btn" id="nextMonth">ä¸‹æœˆ â–¶</button>
          <button class="nav-btn primary" id="todayBtn">ä»Šå¤©</button>
        </div>
        <div class="nav-links">
          <a href="simple.html" class="nav-link" id="linkSimple">ğŸ“‹ ç²¾ç°¡ç‰ˆ</a>
          <a href="detail.html" class="nav-link" id="linkDetail">ğŸ“Š è©³ç´°ç‰ˆ</a>
        </div>
      </div>
      <div class="calendar">
        <div class="calendar-header">
          <div>æ—¥</div>
          <div>ä¸€</div>
          <div>äºŒ</div>
          <div>ä¸‰</div>
          <div>å››</div>
          <div>äº”</div>
          <div>å…­</div>
        </div>
        <div class="calendar-grid" id="calendarGrid">
          <div class="loading">è¼‰å…¥ä¸­...</div>
        </div>
      </div>
      <div class="legend">
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--holiday-bg);
              border: 1px solid var(--holiday);
            "
          ></div>
          åœ‹å®šå‡æ—¥
        </div>
        <div class="legend-item">
          <span style="color: #9e9e9e; font-size: 11px">å‘¨ä¼‘</span>
          (ç´”æ–‡å­—)
        </div>
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--adjusted-bg);
              border: 1px solid var(--adjusted);
            "
          ></div>
          èª¿æ•´æ”¾å‡
        </div>
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--workday-bg);
              border: 1px solid var(--workday);
            "
          ></div>
          è£œç­æ—¥
        </div>
        <div class="legend-item">
          <div
            class="legend-color"
            style="
              background: var(--special-bg);
              border: 1px solid var(--special);
            "
          ></div>
          ç‰¹æ®Šç¯€æ—¥
        </div>
      </div>
      <div class="footer">è³‡æ–™ä¾†æºï¼šæ”¿åºœé–‹æ”¾è³‡æ–™å¹³å°</div>
    </div>
    <script>
      const DATA_PATH = "opendata/holiday";
      const yearSelect = document.getElementById("yearSelect");
      const monthSelect = document.getElementById("monthSelect");
      const calendarGrid = document.getElementById("calendarGrid");
      let currentYear,
        currentMonth,
        holidayData = {},
        availableYears = [];

      // åˆå§‹åŒ–æœˆä»½é¸å–®
      for (let m = 1; m <= 12; m++) {
        monthSelect.innerHTML += `<option value="${m}">${m}æœˆ</option>`;
      }

      async function init() {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        try {
          const res = await fetch(`${DATA_PATH}/years.json`);
          availableYears = await res.json();
          yearSelect.innerHTML = availableYears
            .map((y) => `<option value="${y}">${y}</option>`)
            .join("");
          if (!availableYears.includes(String(currentYear))) {
            currentYear = parseInt(availableYears[0]);
          }
          yearSelect.value = currentYear;
          monthSelect.value = currentMonth;
          updateLinks();
          await loadYear(currentYear);
          renderCalendar();
        } catch (e) {
          calendarGrid.innerHTML = `<div class="loading">è¼‰å…¥å¤±æ•—: ${e.message}</div>`;
        }
      }

      async function loadYear(year) {
        if (holidayData[year]) return;
        try {
          const res = await fetch(`${DATA_PATH}/${year}.json`);
          if (res.ok) holidayData[year] = await res.json();
        } catch (e) {
          console.warn(`ç„¡æ³•è¼‰å…¥ ${year} å¹´è³‡æ–™`);
        }
      }

      function updateLinks() {
        document.getElementById(
          "linkSimple"
        ).href = `simple.html?year=${currentYear}`;
        document.getElementById(
          "linkDetail"
        ).href = `detail.html?year=${currentYear}`;
      }

      /**
       * å–å¾—äº‹ä»¶é¡¯ç¤ºæ–‡å­—ï¼ˆå¥—ç”¨ç²¾ç°¡ç‰ˆé‚è¼¯ï¼‰
       * @param {Object} item - å‡æ—¥è³‡æ–™ç‰©ä»¶
       * @param {boolean} isWeekend - æ˜¯å¦ç‚ºé€±æœ«
       * @returns {Object} { display: é¡¯ç¤ºæ–‡å­—, tooltip: æç¤ºæ–‡å­—, type: é¡å‹ }
       */
      function getEventDescription(item, isWeekend) {
        const isHoliday = item.holiday;
        const name = (item.name || "").trim();
        const desc = (item.description || "").trim();
        const category = (item.holidayCategory || "").trim();
        let display = "";
        let type = "holiday"; // holiday, workday, special

        if (!isHoliday || category === "è£œè¡Œä¸Šç­æ—¥") {
          // è£œç­æ—¥
          display = name ? `è£œç­(${name})` : "è£œç­";
          type = "workday";
        } else if (category === "æ˜ŸæœŸå…­ã€æ˜ŸæœŸæ—¥") {
          // å‘¨ä¼‘
          display = name ? `å‘¨ä¼‘(${name})` : "å‘¨ä¼‘";
          type = "weekend";
        } else if (category === "èª¿æ•´æ”¾å‡æ—¥") {
          // èª¿æ•´æ”¾å‡ï¼ˆå¦‚å°å¹´å¤œï¼‰
          display = name || "èª¿æ•´æ”¾å‡";
          type = "adjusted";
        } else if (category === "æ”¾å‡ä¹‹ç´€å¿µæ—¥åŠç¯€æ—¥") {
          // åœ‹å®šå‡æ—¥
          display = name || "åœ‹å®šå‡æ—¥";
          type = "holiday";
        } else if (name) {
          // å…¶ä»–æœ‰åç¨±çš„ç¯€æ—¥ï¼ˆå¦‚ç¯€æ°£ï¼‰
          display = name;
          type = "special";
        } else {
          // å…¶ä»–è£œå‡
          display = "è£œå‡";
          type = "holiday";
        }

        return {
          display,
          tooltip: desc || `${category}${name ? ": " + name : ""}`,
          type,
        };
      }

      function renderCalendar() {
        const firstDay = new Date(currentYear, currentMonth - 1, 1);
        const lastDay = new Date(currentYear, currentMonth, 0);
        // é€±æ—¥é–‹å§‹: getDay() é€±æ—¥=0, é€±ä¸€=1, ..., é€±å…­=6
        const startDay = firstDay.getDay();
        const daysInMonth = lastDay.getDate();
        const today = new Date();
        const todayStr = `${today.getFullYear()}/${String(
          today.getMonth() + 1
        ).padStart(2, "0")}/${String(today.getDate()).padStart(2, "0")}`;

        const yearData = holidayData[currentYear] || [];
        const dateMap = {};
        yearData.forEach((h) => {
          dateMap[h.date] = h;
        });

        let html = "";
        // ä¸Šæœˆè£œä½
        const prevMonth = new Date(currentYear, currentMonth - 1, 0);
        for (let i = startDay - 1; i >= 0; i--) {
          const d = prevMonth.getDate() - i;
          html += `<div class="day-cell other-month"><span class="day-number">${d}</span></div>`;
        }
        // ç•¶æœˆ
        for (let d = 1; d <= daysInMonth; d++) {
          // JSON è³‡æ–™æ—¥æœŸæ ¼å¼ç‚º YYYYMMDD (å¦‚ 20250127)
          const dateKey = `${currentYear}${String(currentMonth).padStart(
            2,
            "0"
          )}${String(d).padStart(2, "0")}`;
          // é¡¯ç¤ºç”¨æ ¼å¼ YYYY/MM/DD
          const dateDisplay = `${currentYear}/${String(currentMonth).padStart(
            2,
            "0"
          )}/${String(d).padStart(2, "0")}`;
          const dayOfWeek = new Date(currentYear, currentMonth - 1, d).getDay();
          const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
          const isToday = dateDisplay === todayStr;
          const h = dateMap[dateKey];

          let classes = "day-cell";
          if (isWeekend) classes += " weekend";
          if (isToday) classes += " today";

          let events = "";
          if (h) {
            // å¥—ç”¨ç²¾ç°¡ç‰ˆé‚è¼¯ï¼šé¡¯ç¤ºå‘¨ä¼‘ã€è£œç­ç­‰è³‡è¨Š
            const eventInfo = getEventDescription(h, isWeekend);
            // æ ¹æ“šé¡å‹è¨­å®šä¸åŒçš„æ¨£å¼ class
            const eventClass = `event ${eventInfo.type}`;
            events = `<div class="${eventClass}" title="${eventInfo.tooltip}">${eventInfo.display}</div>`;
          }

          html += `<div class="${classes}"><span class="day-number">${d}</span><div class="day-events">${events}</div></div>`;
        }
        // è¨ˆç®—éœ€è¦å¹¾é€±
        const totalCells = startDay + daysInMonth;
        const weeksNeeded = Math.ceil(totalCells / 7);
        const targetCells = weeksNeeded * 7;
        // ä¸‹æœˆè£œä½ - å¡«æ»¿è©²é€±æ•¸æ‰€éœ€çš„æ ¼å­
        const remaining = targetCells - totalCells;
        for (let d = 1; d <= remaining; d++) {
          html += `<div class="day-cell other-month"><span class="day-number">${d}</span></div>`;
        }
        // è¨­å®šé€±æ•¸ class ä»¥èª¿æ•´æ ¼å­é«˜åº¦
        calendarGrid.className = `calendar-grid weeks-${weeksNeeded}`;
        calendarGrid.innerHTML = html;
      }

      async function changeMonth(delta) {
        currentMonth += delta;
        if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        } else if (currentMonth < 1) {
          currentMonth = 12;
          currentYear--;
        }
        if (!availableYears.includes(String(currentYear))) {
          currentYear = parseInt(
            availableYears[delta > 0 ? 0 : availableYears.length - 1]
          );
          currentMonth = delta > 0 ? 1 : 12;
        }
        yearSelect.value = currentYear;
        monthSelect.value = currentMonth;
        updateLinks();
        await loadYear(currentYear);
        renderCalendar();
      }

      document.getElementById("prevMonth").onclick = () => changeMonth(-1);
      document.getElementById("nextMonth").onclick = () => changeMonth(1);
      document.getElementById("todayBtn").onclick = async () => {
        const today = new Date();
        currentYear = today.getFullYear();
        currentMonth = today.getMonth() + 1;
        if (!availableYears.includes(String(currentYear))) {
          currentYear = parseInt(availableYears[0]);
        }
        yearSelect.value = currentYear;
        monthSelect.value = currentMonth;
        updateLinks();
        await loadYear(currentYear);
        renderCalendar();
      };
      yearSelect.onchange = async () => {
        currentYear = parseInt(yearSelect.value);
        updateLinks();
        await loadYear(currentYear);
        renderCalendar();
      };
      monthSelect.onchange = () => {
        currentMonth = parseInt(monthSelect.value);
        renderCalendar();
      };

      init();
    </script>
  </body>
</html>
